# Go Booking Service
This Booking Service allows the following:
- Authorize a user using "user" and "password". Returns a signed JWT.
- Validate a JWT. For internal validation.
- Create a user with a password.
- Book a room for a desired date. Requires a valid JWT. Returns the booked room id.
- Check the number of available rooms for a desired date. Returns the number of rooms available.

The project is divided in various micoservices:
- Clients: manages client authentication, token generation and validation
- Rooms: manages room access, booking and availability
- Server: proxies the previous services and provides access via HTTP

The services communicate via gRPC.

JSON Web Tokens used for authentication look like the following:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjM3NTM4NjQwMDAsInVzZXIiOiJDaGFybGVzIn0.G6W-WSfOoBxq7Be1bGqgKvYFb_toMdzbCZmT1n6PzVA
```

## Installation

### Clone the repository
```
git clone https://github.com/santiago-tolley/go-booking-service.git
```
### Compile Protobufs
```
make build-proto
```
Note: install protoc-gen-go with `go get -u github.com/golang/protobuf/protoc-gen-go`

### Create Go module
```
make init-mod
```

### Build
```
make build
```

### Set up the database
#### Set up in installed mongodb
Initialize using the script `init-mongo.js`:
```
make init-db
```

#### Set up in docker:
Build the image, start the container and run the script:
```
make docker-build-db
make docker-start-d
make docker-init-db
```

#### Set up manually:
Create the client user (and client test user):
```
mongo
use clients-service
db.createUser({user: "clients-service", pwd: "clients-service", roles: [{role: "readWrite", db: "clients-service"}]})
db.users.createIndex({"user": 1}, {unique: true})

use test-clients-service
db.createUser({user: "test-clients-service", pwd: "test-clients-service", roles: [{role: "readWrite", db: "test-clients-service"}]})
db.users.createIndex({"user": 1}, {unique: true})
```

Create the room user (and room test user):
```
mongo
use rooms-service
db.createUser({user: "rooms-service", pwd: "rooms-service", roles: [{role: "readWrite", db: "rooms-service"}]})
db.rooms.createIndex({"room_id": 1}, {unique: true})

use test-rooms-service
db.createUser({user: "test-rooms-service", pwd: "test-rooms-service", roles: [{role: "readWrite", db: "test-rooms-service"}]})
db.rooms.createIndex({"room_id": 1}, {unique: true})
```


## Running the Services
Start the services with the following commands:
```
make run_clients
make run_rooms
make run_server
```
The default ports for the services are the following:
- Server service: 8080 (HTTP)
- Clients service: 8082 (gRPC)
- Rooms service: 8081 (gRPC)

## Running Tests
To run tests use the following commands:
```
make test
```

For the verbose output use: 
```
make test-v
```

## Calling the Proxy
The endpoints can be called using the following cURL commands:
### Authorize: 
```
curl --location --request POST 'localhost:8080/authorize/' \
--header 'Content-Type: application/json' \
--data-raw '{
	"user": "John",
	"password": "pass"
}'
```

### Validate: 
```
curl --location --request POST 'localhost:8080/validate/' \
--header 'Content-Type: application/json' \
--data-raw '{
	"token": "jjj.www.ttt"
}'
```

### Create: 
```
curl --location --request POST 'localhost:8080/create/' \
--header 'Content-Type: application/json' \
--data-raw '{
	"user": "John",
	"password": "pass"
}'
```

### Book: 
```
curl --location --request POST 'localhost:8080/book/2020-01-15' \
--header 'Content-Type: application/json' \
--data-raw '{
	"token": "jjj.www.ttt"
}'
```

### Check: 
```
curl --location --request GET 'localhost:8080/check/2020-01-15'
```
Note: the `/book/` and `/validate/` endpoints require a JWT generated by `/authorize/`

## Makefile
For a list of commands in the makefile run:
```
make help
```